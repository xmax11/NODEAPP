name: Deploy Node.js App to EC2 Instance

on:
 push:
  branches:
   - main

jobs:
 deploy:
   runs-on: ubuntu-latest
   steps: 
   - name: checkout code
     uses: actions/checkout@v3

   - name: copy files to EC2
     uses: appleboy/scp-action@v0.1.7
     with:
      host: ${{ secrets.EC2_HOST }}
      username: ${{ secrets.EC2_USER }}
      key: ${{ secrets.EC2_SSH_KEY }}
      source: "./**"
      target: "~/NODEAPP"
   
   - name: Deploy on EC2
     uses: appleboy/ssh-action@v1.0.3
     with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/NODEAPP
            docker build -t nodeapp-image .
            docker stop nodeapp-container || true
            docker rm nodeapp-container || true
            docker run -d -p 3000:3000 --name nodeapp-container nodeapp-image

   
